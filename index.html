<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Animal Run</title>
  <style>
    :root{
      --sky:#bde0fe; --sky2:#90cdf4; --grass:#84cc16; --ink:#0f172a; --panel:#ffffff;
      --line:#0c4a6e; --hit:#ef4444; --heal:#22c55e; --bar:#0ea5e9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif; color:var(--ink); background:linear-gradient(var(--sky),var(--sky2))}
    .wrap{max-width:1100px; margin:auto; padding:16px; display:flex; flex-direction:column; gap:14px}
    header{display:flex; align-items:center; justify-content:space-between; gap:10px}
    h1{margin:0; font-size:28px}
    .btn{cursor:pointer; border:2px solid #0002; background:#ffd166; border-radius:12px; padding:10px 14px; font-weight:700}
    .panel{background:var(--panel); border:3px solid #0002; border-radius:18px}

    /* Controls */
    .controls{display:flex; flex-wrap:wrap; gap:8px; padding:10px; align-items:center}
    .controls input{border:2px solid #0002; border-radius:12px; padding:10px; font-size:14px}

    /* Gallery */
    .gallery{display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:12px; padding:12px}
    .card{border:3px solid #0002; border-radius:16px; padding:8px; cursor:pointer; background:#fff; transition:transform .08s}
    .card:hover{transform:translateY(-2px)}
    .thumb{width:100%; aspect-ratio:1/1; border-radius:12px; background:#fff; display:grid; place-items:center}
    .thumb img{width:92%; height:92%; object-fit:cover; border-radius:12px}
    .label{margin-top:6px; text-align:center; font-weight:700}

    /* Arena */
    .arena{display:none}
    .arena.show{display:block}
    .stage{position:relative; border:3px solid #0002; border-radius:18px; overflow:hidden; min-height:420px; background:linear-gradient(#dbeafe 55%, var(--grass) 0)}
    .ground{position:absolute; inset:auto 0 0 0; height:45%; background:repeating-linear-gradient(90deg,#7bbf10,#7bbf10 16px,#76b50f 16px,#76b50f 32px)}

    .fighter{position:absolute; bottom:90px; width:210px; height:210px; display:grid; place-items:center; filter:drop-shadow(0 12px 0 #0001)}
    .fighter img{width:100%; height:100%; object-fit:contain; border-radius:16px}
    .left{left:6%}
    .right{right:6%}

    .hpbar{position:absolute; top:12px; width:44%; height:16px; background:#fff; border:3px solid #0002; border-radius:999px; overflow:hidden}
    .hpbar.left{left:12px}
    .hpbar.right{right:12px}
    .hp{height:100%; width:100%; background:linear-gradient(90deg,var(--heal),#bbf7d0)}
    .hpR{background:linear-gradient(90deg,var(--hit),#fecaca)}

    .vs{position:absolute; top:8px; left:50%; transform:translateX(-50%); background:#fff; border:3px solid #0002; padding:4px 10px; border-radius:999px; font-weight:900}

    .log{margin:10px; padding:10px; border:3px solid #0002; border-radius:14px; background:#fff; min-height:44px}

    /* Cage */
    .cage{position:absolute; inset:0; display:grid; place-items:center; background:#0000002b;}
    .bars{position:relative; width:70%; height:70%; border-radius:18px; background:repeating-linear-gradient(90deg, #324051 0 12px, transparent 12px 32px); border:3px solid #475569; box-shadow:inset 0 0 0 3px #0b1220}
    .door{position:absolute; inset:0; border-radius:18px; background:linear-gradient(180deg,#1f2937,#111827); border-left:4px solid #94a3b8; transform-origin:left;}
    .cage.open .door{animation:door 1300ms ease forwards}
    @keyframes door{to{transform:perspective(700px) rotateY(70deg) translateX(-6%); opacity:.15}}

    /* Motion */
    @keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .idle{animation:bob 1.1s ease-in-out infinite}
    @keyframes runL{0%{transform:translateX(0)} 50%{transform:translateX(120px)} 100%{transform:translateX(0)}}
    @keyframes runR{0%{transform:translateX(0)} 50%{transform:translateX(-120px)} 100%{transform:translateX(0)}}
    @keyframes collide{0%{transform:scale(1)} 40%{transform:scale(1.05) rotate(2deg)} 100%{transform:scale(1)}}
    .speed{position:absolute; width:120px; height:4px; background:linear-gradient(90deg,#0000,var(--line)); border-radius:8px; opacity:.6}

    .count{position:absolute; inset:0; display:grid; place-items:center; font-size:110px; font-weight:900; color:#0008; text-shadow:0 4px 0 #fff}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üèÉ‚Äç‚ôÇÔ∏è Animal Run</h1>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn" id="saveDefaults">Save as my defaults</button>
        <button class="btn" id="goHome" style="display:none">Back to Gallery</button>
      </div>
    </header>

    <div class="panel controls">
      <input id="nameInput" type="text" placeholder="Animal name (optional)" />
      <input id="urlInput" type="url" placeholder="Paste image URL (HTTPS)" />
      <button class="btn" id="addUrl">Add by URL</button>
      <input id="fileInput" type="file" accept="image/*" multiple />
      <span style="font-size:12px;opacity:.8">(Tip: add your images, then click "Save as my defaults" so they preload next time.)</span>
    </div>

    <section class="panel" id="galleryPanel">
      <div class="gallery" id="gallery"></div>
    </section>

    <section class="arena" id="arena">
      <div class="stage" id="stage">
        <div class="hpbar left"><div class="hp" id="hpLeft"></div></div>
        <div class="hpbar right"><div class="hp hpR" id="hpRight"></div></div>
        <div class="vs">VS</div>
        <div class="fighter left idle" id="boxL"><img id="imgL" alt="left animal"/></div>
        <div class="fighter right idle" id="boxR"><img id="imgR" alt="right animal"/></div>
        <div class="ground"></div>
        <div class="count" id="countdown" style="display:none">3</div>
      </div>
      <div class="log" id="log">Pick an animal to start‚Ä¶</div>
      <div style="display:flex; gap:8px; padding:8px 10px">
        <button class="btn" id="playAgain" style="display:none">Play again</button>
      </div>
    </section>
  </div>

  <script>
    // ---------- Configuration: put YOUR animal URLs here to preload ----------
    // If you click "Save as my defaults", we'll store your current list in localStorage
    const PRELOADED = [
      {name:'Lion', src: svg('Lion','#fde047','ü¶Å')},
      {name:'Tiger', src: svg('Tiger','#fb923c','üêØ')},
      {name:'Elephant', src: svg('Elephant','#93c5fd','üêò')},
      {name:'Panda', src: svg('Panda','#c4b5fd','üêº')}
      // Example real photo URL: {name:'Cheetah', src:'https://images.unsplash.com/photo-1546182990-dffeafbe841d?w=800'}
    ];

    const gallery = document.getElementById('gallery');
    const arena = document.getElementById('arena');
    const stage = document.getElementById('stage');
    const imgL = document.getElementById('imgL');
    const imgR = document.getElementById('imgR');
    const boxL = document.getElementById('boxL');
    const boxR = document.getElementById('boxR');
    const hpLeft = document.getElementById('hpLeft');
    const hpRight = document.getElementById('hpRight');
    const countdownEl = document.getElementById('countdown');
    const log = document.getElementById('log');

    let animals = [];

    const el = (t,a={},...c)=>{const n=document.createElement(t);Object.entries(a).forEach(([k,v])=>{if(k==='style'&&typeof v==='object')Object.assign(n.style,v);else if(k.startsWith('on'))n.addEventListener(k.slice(2),v);else n.setAttribute(k,v)});c.flat().forEach(x=>n.appendChild(typeof x==='string'?document.createTextNode(x):x));return n}

    function addAnimal(src,name){animals.push({name:name?.trim()||infer(src),src});renderGallery()}
    function infer(src){try{const u=new URL(src);const f=u.pathname.split('/').pop();return (f?.split('.')?.[0]||'Animal').replace(/[-_]/g,' ')}catch{return 'Animal'}}

    function renderGallery(){
      gallery.innerHTML='';
      animals.forEach((a,i)=>{
        gallery.appendChild(el('button',{class:'card',onclick:()=>selectAnimal(i)},
          el('div',{class:'thumb'}, el('img',{src:a.src,alt:a.name})),
          el('div',{class:'label'}, a.name)
        ))
      })
    }

    // ---- Add images by URL / file ----
    document.getElementById('addUrl').addEventListener('click',()=>{
      const url=document.getElementById('urlInput').value.trim();
      const name=document.getElementById('nameInput').value.trim();
      if(!url) return alert('Paste an image URL first.');
      addAnimal(url,name||undefined);
      document.getElementById('urlInput').value='';
      document.getElementById('nameInput').value='';
    })
    const fileInput=document.getElementById('fileInput');
    fileInput.addEventListener('change',e=>{
      const files=[...e.target.files];
      files.forEach(f=>{if(!f.type.startsWith('image/'))return;const r=new FileReader();r.onload=()=>addAnimal(r.result,f.name.replace(/\.[^.]+$/,''));r.readAsDataURL(f)});
      fileInput.value='';
    })

    // ---- Save defaults ----
    document.getElementById('saveDefaults').addEventListener('click',()=>{
      localStorage.setItem('animalrun.defaults', JSON.stringify(animals));
      alert('Saved! These animals will preload next time.');
    })

    // ---- Game flow with "real" cage escape and charges ----
    function selectAnimal(index){
      if(animals.length<2){alert('Add at least two animals.');return}
      const p=animals[index];
      let j=index; while(j===index) j=Math.floor(Math.random()*animals.length);
      const o=animals[j];

      document.getElementById('galleryPanel').style.display='none';
      arena.classList.add('show');
      document.getElementById('goHome').style.display='inline-block';

      imgL.src=p.src; imgR.src=o.src;
      hpLeft.style.width='100%'; hpRight.style.width='100%';
      log.textContent = `${p.name} is trapped in a cage‚Ä¶`;

      // Build cage overlay over left fighter
      const cage = el('div',{class:'cage',id:'cage'}, el('div',{class:'bars'}, el('div',{class:'door'})));
      stage.appendChild(cage);

      // Open door, then run out, then fight
      setTimeout(()=>{ cage.classList.add('open'); }, 900);
      setTimeout(()=>{
        cage.remove();
        // left animal runs forward visibly
        runOnce(boxL,'L',()=> countdown(()=> startFight(p,o)));
      }, 2400);
    }

    function runOnce(node,dir='L',done){
      // add speed lines for fun
      const s = el('div',{class:'speed'}); stage.appendChild(s); s.style.top = (node.offsetTop+node.offsetHeight/2)+'px'; s.style.left = (dir==='L'? (node.offsetLeft+30)+'px' : (node.offsetLeft-120)+'px');
      node.style.animation = dir==='L'? 'runL 700ms ease' : 'runR 700ms ease';
      setTimeout(()=>{ node.style.animation='bob 1.1s ease-in-out infinite'; s.remove(); done&&done(); },720);
    }

    function countdown(done){
      countdownEl.style.display='grid';
      let n=3; countdownEl.textContent=n;
      const t=setInterval(()=>{ n--; if(n>0) countdownEl.textContent=n; else { countdownEl.textContent='Go!'; setTimeout(()=>{ countdownEl.style.display='none'; clearInterval(t); done(); },500);} },650);
    }

    function startFight(p,o){
      boxL.classList.add('idle'); boxR.classList.add('idle');
      let L=100,R=100; let turn=0; // 0 left, 1 right
      const tick=setInterval(()=>{
        const dmg = 8+Math.floor(Math.random()*13);
        if(turn===0){
          // left charges, collide at center, right loses HP
          charge(boxL,'L');
          R=Math.max(0,R-dmg); hpRight.style.width=R+'%';
          log.textContent=`${p.name} hits ${o.name} for ${dmg}!`;
        } else {
          charge(boxR,'R');
          L=Math.max(0,L-dmg); hpLeft.style.width=L+'%';
          log.textContent=`${o.name} hits ${p.name} for ${dmg}!`;
        }
        if(L===0||R===0){
          clearInterval(tick);
          const winner = R===0&&L>0? p : (L===0&&R>0? o : (Math.random()<.5?p:o));
          log.textContent = `üèÜ ${winner.name} wins!`;
          document.getElementById('playAgain').style.display='inline-block';
        } else { turn = 1 - turn; }
      }, 1100);
    }

    function charge(node,dir){
      node.classList.remove('idle');
      // move towards center then bounce back
      node.style.animation = (dir==='L'? 'runL' : 'runR') + ' 600ms ease';
      // impact wobble on both
      boxL.style.animation = 'collide 400ms'; boxR.style.animation='collide 400ms';
      setTimeout(()=>{ boxL.style.animation='bob 1.1s ease-in-out infinite'; boxR.style.animation='bob 1.1s ease-in-out infinite'; },420);
    }

    // Buttons
    document.getElementById('playAgain').addEventListener('click',()=>{
      log.textContent='Pick an animal to start‚Ä¶';
      document.getElementById('playAgain').style.display='none';
      document.getElementById('galleryPanel').style.display='block';
      arena.classList.remove('show');
      document.getElementById('goHome').style.display='none';
    })
    document.getElementById('goHome').addEventListener('click',()=> document.getElementById('playAgain').click())

    // Confetti-free for now to keep perf light for kids devices

    // Preload helpers
    function svg(text,color,emoji){return `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'><defs><linearGradient id='g' x1='0' x2='0' y1='0' y2='1'><stop offset='0' stop-color='${color}' stop-opacity='.95'/><stop offset='1' stop-color='${color}' stop-opacity='.75'/></linearGradient></defs><rect width='100%' height='100%' rx='28' fill='url(#g)'/><text x='50%' y='48%' text-anchor='middle' font-size='120'>${emoji}</text><text x='50%' y='88%' text-anchor='middle' font-family='Comic Sans MS, Segoe UI, Arial' font-size='36' fill='#000' opacity='.7' font-weight='900'>${text}</text></svg>`)};}

    function loadDefaults(){
      const saved = localStorage.getItem('animalrun.defaults');
      animals = saved ? JSON.parse(saved) : PRELOADED.slice();
      renderGallery();
    }

    // init
    loadDefaults();
  </script>
</body>
</html>
